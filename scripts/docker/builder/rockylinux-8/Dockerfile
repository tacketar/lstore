#
# Autogenerated by lstore-release/scripts/generate-docker-base.sh
#
FROM rockylinux:8
MAINTAINER http://lstore.org
ENV DEBIAN_FRONTEND=noninteractive
RUN yum install -y dnf-plugins-core && yum config-manager --enable powertools
RUN yum groupinstall -y 'Development Tools' && yum install -y epel-release git && yum clean all
RUN yum install -y apr-devel apr-util-devel autoconf ccache curl createrepo expat-devel fuse3-devel libtool libacl-devel libsodium-devel openssl-devel rsync tar wget which zeromq-devel zlib-devel python3 cmake && yum clean all
#Manually Building RocksDB!!!  Notice how we keep remving any shared libs so RocksDB does the right thing
RUN yum install -y zlib-devel bzip2-devel lz4-devel snappy-devel

#Now build gflags from source and only make static libs
RUN cd /tmp &&     git clone https://github.com/gflags/gflags.git &&     cd gflags &&     git checkout v2.0 &&     ./configure --disable-shared && make -j16 && make install

#Build zstandard and remove shared libs to force static linking
RUN cd /tmp &&     wget https://github.com/facebook/zstd/archive/v1.1.3.tar.gz &&     mv v1.1.3.tar.gz zstd-1.1.3.tar.gz &&     tar zxvf zstd-1.1.3.tar.gz &&     cd zstd-1.1.3 &&     make CFLAGS="-fPIC -O3" -j16 && make install && rm /usr/local/lib/libzstd*so*

#And finally RocksDB static lib.  This way all the custom built software doesn't have to propagated
#The latest RocksDB uses the c++17 extension which isn't supported on RHEL7 so we use an older version of RocksDB
RUN cd /tmp &&     git clone https://github.com/facebook/rocksdb.git &&     cd rocksdb &&     git checkout 6.29.fb &&     EXTRA_CFLAGS="-fPIC" EXTRA_CXXFLAGS="-fPIC" EXTRA_LDFLAGS="-fPIC" PORTABLE=1 make -j16 static_lib &&     PORTABLE=1 make install-static
